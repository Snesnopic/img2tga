name: Build and Release

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    name: build (${{ matrix.id }})
    runs-on: ${{ matrix.runs_on }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - id: ubuntu-gcc
            runs_on: ubuntu-latest
            build_type: Release
            c_compiler: gcc
            cpp_compiler: g++
            binary_path: bin/Release/img2tga

          - id: ubuntu-clang
            runs_on: ubuntu-latest
            build_type: Release
            c_compiler: clang
            cpp_compiler: clang++
            binary_path: bin/Release/img2tga

          - id: ubuntu-arm
            runs_on: ubuntu-24.04-arm
            build_type: Release
            c_compiler: gcc
            cpp_compiler: g++
            binary_path: bin/Release/img2tga

          - id: macos-intel
            runs_on: macos-15-intel
            build_type: Release
            c_compiler: gcc-12
            cpp_compiler: g++-12
            binary_path: bin/Release/img2tga

          - id: macos-arm
            runs_on: macos-26
            build_type: Release
            c_compiler: clang
            cpp_compiler: clang++
            binary_path: bin/Release/img2tga

          - id: windows-x86
            runs_on: windows-latest
            build_type: Release
            c_compiler: cl
            cpp_compiler: cl
            binary_path: bin/Release/img2tga.exe

          - id: windows-arm
            runs_on: windows-11-arm
            build_type: Release
            c_compiler: cl
            cpp_compiler: cl
            binary_path: bin/Release/img2tga.exe

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build

      - name: Set build output directory
        id: strings
        shell: bash
        run: echo "build-output-dir=${{ github.workspace }}/build" >> "$GITHUB_OUTPUT"

      - name: Configure CMake
        run: >
          cmake -B ${{ steps.strings.outputs.build-output-dir }}
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }}
          -DCMAKE_C_COMPILER=${{ matrix.c_compiler }}
          -S ${{ github.workspace }}

      - name: Build
        run: cmake --build ${{ steps.strings.outputs.build-output-dir }} --config ${{ matrix.build_type }}
      - name: Strip binary (Linux/macOS)
        if: runner.os == 'Linux' || runner.os == 'macOS'
        run: |
            echo "Stripping binary..."
            strip ${{ github.workspace }}/build/${{ matrix.binary_path }}
      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: img2tga-${{ matrix.id }}
          path: ${{ github.workspace }}/build/${{ matrix.binary_path }}
          retention-days: 1

  build-freebsd:
    name: build (freebsd-${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: freebsd-x86
            arch: amd64
          - id: freebsd-arm
            arch: arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build on FreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          arch: ${{ matrix.arch }}
          usesh: true
          prepare: |
            pkg install -y \
              cmake \
              ninja \
              pkgconf \
              gmake \
              git
          run: |
            echo "--- Starting FreeBSD Build ---"
            export CC=clang
            export CXX=clang++
            
            cmake -B build \
              -DCMAKE_BUILD_TYPE=Release \
              -S ${{ github.workspace }}
            
            cmake --build build --config Release
            echo "--- Build Complete ---"
            
            echo "--- Stripping binary ---"
            strip build/bin/Release/img2tga

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: img2tga-${{ matrix.id }}
          path: ${{ github.workspace }}/build/bin/Release/img2tga
          retention-days: 1

  publish-latest:
    name: Publish Latest Pre-Release
    runs-on: ubuntu-latest
    needs: [build, build-freebsd]

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: List downloaded artifacts
        run: ls -R artifacts/

      - name: Prepare assets for release
        run: |
          mkdir release_assets
           
          # --- Linux (gcc) ---
          mv artifacts/img2tga-ubuntu-gcc/img2tga release_assets/img2tga-ubuntu-gcc
          tar -czf release_assets/img2tga-ubuntu-gcc.tar.gz -C release_assets img2tga-ubuntu-gcc
          rm release_assets/img2tga-ubuntu-gcc

          # --- Linux (clang) ---
          mv artifacts/img2tga-ubuntu-clang/img2tga release_assets/img2tga-ubuntu-clang
          tar -czf release_assets/img2tga-ubuntu-clang.tar.gz -C release_assets img2tga-ubuntu-clang
          rm release_assets/img2tga-ubuntu-clang

          # --- Linux (arm) ---
          mv artifacts/img2tga-ubuntu-arm/img2tga release_assets/img2tga-ubuntu-arm
          tar -czf release_assets/img2tga-ubuntu-arm.tar.gz -C release_assets img2tga-ubuntu-arm
          rm release_assets/img2tga-ubuntu-arm

          # --- macOS (intel) ---
          mv artifacts/img2tga-macos-intel/img2tga release_assets/img2tga-macos-intel
          tar -czf release_assets/img2tga-macos-intel.tar.gz -C release_assets img2tga-macos-intel
          rm release_assets/img2tga-macos-intel

          # --- macOS (arm) ---
          mv artifacts/img2tga-macos-arm/img2tga release_assets/img2tga-macos-arm
          tar -czf release_assets/img2tga-macos-arm.tar.gz -C release_assets img2tga-macos-arm
          rm release_assets/img2tga-macos-arm

          # --- Windows (x86) ---
          mv artifacts/img2tga-windows-x86/img2tga.exe release_assets/img2tga-windows-x86.exe
          zip -j release_assets/img2tga-windows-x86.zip release_assets/img2tga-windows-x86.exe
          rm release_assets/img2tga-windows-x86.exe

          # --- Windows (arm) ---
          mv artifacts/img2tga-windows-arm/img2tga.exe release_assets/img2tga-windows-arm.exe
          zip -j release_assets/img2tga-windows-arm.zip release_assets/img2tga-windows-arm.exe
          rm release_assets/img2tga-windows-arm.exe
          
          # --- FreeBSD (x86) ---
          mv artifacts/img2tga-freebsd-x86/img2tga release_assets/img2tga-freebsd-x86
          tar -czf release_assets/img2tga-freebsd-x86.tar.gz -C release_assets img2tga-freebsd-x86
          rm release_assets/img2tga-freebsd-x86
          
          # --- FreeBSD (arm) ---
          mv artifacts/img2tga-freebsd-arm/img2tga release_assets/img2tga-freebsd-arm
          tar -czf release_assets/img2tga-freebsd-arm.tar.gz -C release_assets img2tga-freebsd-arm
          rm release_assets/img2tga-freebsd-arm

      - name: Delete and recreate 'latest-build' release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete latest-build -y || echo "No previous 'latest-build' release to delete."
          git push origin --delete latest-build || echo "No previous 'latest-build' tag to delete."
          gh release create latest-build \
            --prerelease \
            --title "Latest Build (from main)" \
            --notes "Latest successful build from the 'main' branch. This is not a stable, versioned release." \
            release_assets/*